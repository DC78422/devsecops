include:
  - local: 'functions.gitlab-ci.yml'

variables:
  SBOM_PATH_SYFT: "reports/cdx-sbom.syft.json"

Forming CycloneDX SBOM (Docker):
  stage: Audit (image)
  extends:
    - ".artifacts"
    - ".audit_base"
    - ".audit_rule"
    - ".DefectDojo_variables"
    - ".extended_runner_resource_request"
  variables:
    AUDIT_IMAGE: harbor.example.com/devops/syft:latest
    KUBERNETES_SERVICE_ACCOUNT_OVERWRITE: "builder"
  script:
    - syft login $TARGET_REGISTRY -u $TARGET_REGISTRY_LOGIN -p $TARGET_REGISTRY_PASSWORD
    - syft scan $IMAGE_TO_SCAN
      -o cyclonedx-json > $SBOM_PATH_SYFT
  after_script:
    - |
      if [ "$DT_UPLOAD_REPORT" = 'true' ]; then
        echo "Uploading"
        dt-wrapper --dt-sbom-path $SBOM_PATH_SYFT --dt-enable-project-properties
      fi
  when: manual

# Uploading Syft SBOM to Dependency Track:
#   extends:
#     - ".Uploading_SBOM_to_Dependency_Track"
#     - ".audit_rule"
#   variables:
#     SBOM_PATH: $SBOM_PATH_SYFT
#   needs: ["Syft CycloneDX SBOM"]

# DefectDojo Engagement Creation:
#   extends:
#     - ".DefectDojo_Engagement_Creation"
